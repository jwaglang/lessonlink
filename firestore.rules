rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function isAdmin() {
      return request.auth.token.email == 'jwag.lang@gmail.com';
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isTeacher() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/teacherProfiles/$(request.auth.uid));
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Legacy helper (kept for non-query use; DO NOT use for list/query auth in /messages)
    function isAssociatedStudent(studentId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/students/$(studentId)) &&
        get(/databases/$(database)/documents/students/$(studentId)).data.email == request.auth.token.email;
    }

    // Returns teacher UID assigned to a given studentId (or null if missing)
    function assignedTeacherUid(studentId) {
      return get(/databases/$(database)/documents/students/$(studentId)).data.assignedTeacherId;
    }

    // Checks whether a uid belongs to a teacher profile
    function isTeacherUid(uid) {
      return exists(/databases/$(database)/documents/teacherProfiles/$(uid));
    }

    // Checks whether a uid belongs to a student document id (studentId)
    function isStudentUid(uid) {
      return exists(/databases/$(database)/documents/students/$(uid));
    }

    // NEW: Get the auth UID stored on a student document
    // Safe to use for create validation, but not for list/query auth.
    function studentAuthUid(studentId) {
      return get(/databases/$(database)/documents/students/$(studentId)).data.authUid;
    }

    // For creates: validate participants matches the student<->teacher relationship
    function isParticipantForCreate() {
      return (request.resource.data.participants is list) &&
        request.resource.data.participants.size() == 1 &&
        request.resource.data.participants[0] == (request.resource.data.to + ":" + request.resource.data.from);
    }

    // ===================================
    // Collection Rules
    // ===================================

    match /students/{studentId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.email == request.auth.token.email;
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /availability/{availId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // ===================================
    // SESSION INSTANCES (booked classes)
    // ===================================
    match /sessionInstances/{sessionInstanceId} {
      allow read, list: if isAuthenticated();
      allow create, update, delete: if isAdmin() || isTeacher();
    }

    match /courseTemplates/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /courses/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /teacherProfiles/{teacherId} {
      allow read, list: if isAuthenticated();
      allow write: if isOwner(teacherId) || isAdmin();
    }

    match /reviews/{reviewId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /approvalRequests/{reqId} {
      allow create: if isAuthenticated();
      allow read, list: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /userSettings/{settingId} {
      allow read, write: if isAuthenticated();
    }

    match /studentPackages/{pkgId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /units/{unitId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /levels/{levelId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /sessions/{sessionId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworks/{homeworkId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /projects/{projectId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworkSubmissions/{submissionId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin() || isTeacher();
    }

    match /studentProgress/{progressId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /studentRewards/{rewardId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /assessmentReports/{reportId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /studentCredit/{creditId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    // ===================================
    // MESSAGES (Chat + Notifications)
    // ===================================
    match /messages/{messageId} {

      // Teachers/Admins have full access
      allow read, list, write: if isTeacher() || isAdmin();

      // Students: query-safe authorization (NO get()/exists() here)
      // Requires each message doc to include: studentAuthUid (string)
      allow read, list: if
        isAuthenticated() &&
        resource.data.studentAuthUid == request.auth.uid;

      // Students can create messages originating from themselves,
      // only to their assigned teacher, and must tag studentAuthUid correctly.
      allow create: if
        isAuthenticated() &&
        request.resource.data.fromType == 'student' &&
        request.resource.data.toType == 'teacher' &&
        (request.resource.data.type == 'communications' || request.resource.data.type == 'notification') &&
        // studentAuthUid must be present and match the authed user
        request.resource.data.studentAuthUid == request.auth.uid &&
        // The claimed studentId (from) must belong to this auth uid (validated via student doc)
        request.resource.data.studentAuthUid == studentAuthUid(request.resource.data.from) &&
        // To must be the assigned teacher uid for that student
        (request.resource.data.to == assignedTeacherUid(request.resource.data.from)) &&
        // participants must be ["teacherUid:studentId"]
        isParticipantForCreate();

      // Students may only mark a message as read if the message belongs to them,
      // only toggling read false->true, and changing nothing else.
      allow update: if
        isAuthenticated() &&
        resource.data.studentAuthUid == request.auth.uid &&
        resource.data.read == false &&
        request.resource.data.read == true &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['read']);
    }
  }
}
