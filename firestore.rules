rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function isAdmin() {
      return request.auth.token.email == 'jwag.lang@gmail.com';
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isTeacher() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/teacherProfiles/$(request.auth.uid));
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Returns teacher UID assigned to a given studentId
    // Note: studentId IS the Auth UID in v7 convention
    function assignedTeacherUid(studentId) {
      return get(/databases/$(database)/documents/students/$(studentId)).data.assignedTeacherId;
    }

    // ===================================
    // Collection Rules
    // ===================================

    // STUDENTS
    // studentId (doc ID) = Auth UID
    match /students/{studentId} {
      // Read: admin, assigned teacher, or the student themselves (doc ID == auth.uid)
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && resource.data.assignedTeacherId == request.auth.uid) ||
        (studentId == request.auth.uid)
      );

      // Create: only if creating their own record (doc ID == auth.uid, email matches)
      allow create: if isAuthenticated() && 
        studentId == request.auth.uid &&
        request.resource.data.email == request.auth.token.email;

      // Updates: admin or teacher only
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /availability/{availId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // ===================================
    // SESSION INSTANCES (booked classes)
    // studentId = Auth UID (v7 convention)
    // ===================================
    match /sessionInstances/{instanceId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        resource.data.studentId == request.auth.uid ||
        resource.data.teacherUid == request.auth.uid
      );

      // Student booking creates a sessionInstance for themselves
      allow create: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && request.resource.data.teacherUid == request.auth.uid) ||
        (
          request.resource.data.studentId == request.auth.uid &&
          request.resource.data.teacherUid is string &&
          request.resource.data.courseId is string &&
          request.resource.data.unitId is string &&
          request.resource.data.sessionId is string &&
          request.resource.data.status == 'scheduled'
        )
      );

      // Teacher or admin can update; student can only update their own (limited)
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.teacherUid == request.auth.uid ||
        (
          resource.data.studentId == request.auth.uid &&
          request.resource.data.studentId == resource.data.studentId &&
          request.resource.data.teacherUid == resource.data.teacherUid &&
          request.resource.data.courseId == resource.data.courseId &&
          request.resource.data.unitId == resource.data.unitId &&
          request.resource.data.sessionId == resource.data.sessionId
        )
      );

      // Only admin or owning teacher can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.teacherUid == request.auth.uid
      );
    }

    match /courseTemplates/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /courses/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /teacherProfiles/{teacherId} {
      allow read, list: if isAuthenticated();
      allow write: if isOwner(teacherId) || isAdmin();
    }

    match /reviews/{reviewId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /approvalRequests/{reqId} {
      allow create: if isAuthenticated();
      allow read, list: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /userSettings/{settingId} {
      allow read, write: if isAuthenticated();
    }

    // studentId = Auth UID
    match /studentPackages/{pkgId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (resource.data.studentId == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    match /units/{unitId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /levels/{levelId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /sessions/{sessionId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworks/{homeworkId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /projects/{projectId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworkSubmissions/{submissionId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin() || isTeacher();
    }

    // studentId = Auth UID
    match /studentProgress/{progressId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (resource.data.studentId == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    // studentId = Auth UID
    match /studentRewards/{rewardId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (resource.data.studentId == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    // studentId = Auth UID
    match /assessmentReports/{reportId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (resource.data.studentId == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    // studentId = Auth UID
    match /studentCredit/{creditId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (resource.data.studentId == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    // studentId = Auth UID
    match /learnerAvailability/{slotId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        isTeacher() ||
        (resource.data.studentId == request.auth.uid)
      );
      allow create: if isAuthenticated() &&
        request.resource.data.studentId == request.auth.uid;
      allow update: if isAuthenticated() &&
        resource.data.studentId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.studentId == request.auth.uid
      );
    }

    // studentId = Auth UID
    match /payments/{paymentId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (resource.data.studentId == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    // ===================================
    // MESSAGES (Chat + Notifications)
    // ===================================
    match /messages/{messageId} {
      allow read, list: if isAuthenticated() && (
        resource.data.to == request.auth.uid ||
        resource.data.from == request.auth.uid ||
        isAdmin()
      );

      allow create: if isAuthenticated() &&
        request.resource.data.from == request.auth.uid &&
        (request.resource.data.type == 'notification' || request.resource.data.type == 'communications') &&
        request.resource.data.timestamp is string &&
        request.resource.data.content is string;

      // Sender can update, recipient can only update read state
      allow update: if isAuthenticated() &&
        (
          request.auth.uid == resource.data.from ||
          (request.auth.uid == resource.data.to && request.resource.data.diff(resource.data).changedKeys().hasOnly(['read']))
        );

      allow delete: if isAdmin();
    }

    // Session Feedback — teachers write, learners read their own
    match /sessionFeedback/{feedbackId} {
      allow read: if request.auth != null && (
        isTeacher() ||
        resource.data.studentId == request.auth.uid
      );
      allow create, update: if request.auth != null && isTeacher();
      allow delete: if false;
    }

    // Imported Payments — admin-only write, teachers read
    match /importedPayments/{paymentId} {
      allow read: if request.auth != null && isTeacher();
      allow create, update: if request.auth != null && request.auth.token.email == 'jwag.lang@gmail.com';
      allow delete: if false;
    }

  }
}
