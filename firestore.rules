rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function isAdmin() {
      return request.auth.token.email == 'jwag.lang@gmail.com';
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isTeacher() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/teacherProfiles/$(request.auth.uid));
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Returns teacher UID assigned to a given studentId (or null if missing)
    function assignedTeacherUid(studentId) {
      return get(/databases/$(database)/documents/students/$(studentId)).data.assignedTeacherId;
    }

    // Get the auth UID stored on a student document (students/{studentId}.authUid)
    function studentAuthUid(studentId) {
      return get(/databases/$(database)/documents/students/$(studentId)).data.authUid;
    }

    // ===================================
    // Collection Rules
    // ===================================

    match /students/{studentId} {
      // QUERY-SAFE:
      // - Admin can read all
      // - Teacher can read only students assigned to them
      // - Student can read only their own student doc (authUid == request.auth.uid)
      //
      // For list/query: Firestore will only allow the query if EVERY returned doc
      // satisfies this predicate (so teachers must query with assignedTeacherId == uid).
      allow read: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && resource.data.assignedTeacherId == request.auth.uid) ||
        (resource.data.authUid == request.auth.uid)
      );

      // Create: only if they are creating their own student record (email matches auth token)
      allow create: if isAuthenticated() && request.resource.data.email == request.auth.token.email;

      // Updates: admin or teacher only (students cannot edit student docs)
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /availability/{availId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    // ===================================
    // SESSION INSTANCES (booked classes)
    // ===================================
    match /sessionInstances/{instanceId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        resource.data.studentAuthUid == request.auth.uid ||
        resource.data.teacherUid == request.auth.uid
      );

      // Student booking creates a sessionInstance for themselves
      allow create: if isAuthenticated() && (
        // Admin can create anything
        isAdmin() ||

        // Teacher can create only if they are the teacher on the instance
        (isTeacher() && request.resource.data.teacherUid == request.auth.uid) ||

        // Student can create only for themselves and must target a teacher UID
        (
          request.resource.data.studentAuthUid == request.auth.uid &&
          request.resource.data.teacherUid is string &&
          request.resource.data.courseId is string &&
          request.resource.data.unitId is string &&
          request.resource.data.sessionId is string &&
          request.resource.data.status == 'scheduled'
        )
      );

      // Teacher or admin can update; student can only update their own (limited)
      allow update: if isAuthenticated() && (
        // Admin override
        isAdmin() ||

        // Owning teacher only
        resource.data.teacherUid == request.auth.uid ||

        // Owning student, with strict field locking
        (
          resource.data.studentAuthUid == request.auth.uid &&
          request.resource.data.studentAuthUid == resource.data.studentAuthUid &&
          request.resource.data.teacherUid == resource.data.teacherUid &&
          request.resource.data.courseId == resource.data.courseId &&
          request.resource.data.unitId == resource.data.unitId &&
          request.resource.data.sessionId == resource.data.sessionId
        )
      );

      // Only admin or owning teacher can delete
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.teacherUid == request.auth.uid
      );
    }

    match /courseTemplates/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /courses/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /teacherProfiles/{teacherId} {
      allow read, list: if isAuthenticated();
      allow write: if isOwner(teacherId) || isAdmin();
    }

    match /reviews/{reviewId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /approvalRequests/{reqId} {
      allow create: if isAuthenticated();
      allow read, list: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /userSettings/{settingId} {
      allow read, write: if isAuthenticated();
    }

    match /studentPackages/{pkgId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (studentAuthUid(resource.data.studentId) == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    match /units/{unitId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /levels/{levelId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /sessions/{sessionId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworks/{homeworkId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /projects/{projectId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworkSubmissions/{submissionId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin() || isTeacher();
    }

    match /studentProgress/{progressId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (studentAuthUid(resource.data.studentId) == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    match /studentRewards/{rewardId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (studentAuthUid(resource.data.studentId) == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    match /assessmentReports/{reportId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (studentAuthUid(resource.data.studentId) == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    match /studentCredit/{creditId} {
      allow read, list: if isAuthenticated() && (
        isAdmin() ||
        (isTeacher() && assignedTeacherUid(resource.data.studentId) == request.auth.uid) ||
        (studentAuthUid(resource.data.studentId) == request.auth.uid)
      );
      allow write: if isAdmin() || isTeacher();
    }

    // ===================================
    // MESSAGES (Chat + Notifications)
    // ===================================
    match /messages/{messageId} {
      allow read, list: if isAuthenticated() && (
        resource.data.to == request.auth.uid ||
        resource.data.from == request.auth.uid ||
        isAdmin()
      );

      allow create: if isAuthenticated() &&
        request.resource.data.from == request.auth.uid &&
        (request.resource.data.type == 'notification' || request.resource.data.type == 'communications') &&
        request.resource.data.timestamp is string &&
        request.resource.data.content is string;

      // Only sender can update (e.g. edits) and recipient can update read state
      allow update: if isAuthenticated() &&
        (
          request.auth.uid == resource.data.from ||
          (request.auth.uid == resource.data.to && request.resource.data.diff(resource.data).changedKeys().hasOnly(['read']))
        );

      allow delete: if isAdmin();
    }

  }
}
