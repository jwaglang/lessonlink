rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // Helper Functions
    // ===================================
    function isAdmin() {
      return request.auth.token.email == 'jwag.lang@gmail.com';
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    function isTeacher() {
      return isAuthenticated() && exists(/databases/$(database)/documents/teacherProfiles/$(request.auth.uid));
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isAssociatedStudent(studentId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/students/$(studentId)) &&
             get(/databases/$(database)/documents/students/$(studentId)).data.email == request.auth.token.email;
    }

    // ===================================
    // Collection Rules
    // ===================================

    // --- Core App Collections ---
    match /students/{studentId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.email == request.auth.token.email;
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /lessons/{lessonId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /availability/{availId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /courseTemplates/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /courses/{courseId} {
      allow read, list: if true;
      allow write: if isAdmin() || isTeacher();
    }

    match /teacherProfiles/{teacherId} {
      allow read, list: if isAuthenticated();
      allow write: if isOwner(teacherId) || isAdmin();
    }

    match /reviews/{reviewId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /approvalRequests/{reqId} {
      allow create: if isAuthenticated();
      allow read, list: if isAuthenticated();
      allow update, delete: if isAdmin() || isTeacher();
    }

    match /userSettings/{settingId} {
      allow read, write: if isAuthenticated();
    }
    
    match /studentPackages/{pkgId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    // --- New Gamification/Curriculum Collections ---

    match /units/{unitId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /levels/{levelId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /sessions/{sessionId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworks/{homeworkId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /projects/{projectId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /homeworkSubmissions/{submissionId} {
      allow read, list: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin() || isTeacher();
    }

    match /studentProgress/{progressId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /studentRewards/{rewardId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /assessmentReports/{reportId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /studentCredit/{creditId} {
      allow read, list: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    match /messages/{messageId} {
      // Teachers/Admins have full access
      allow read, write: if isTeacher() || isAdmin();

      // Student-specific rules
      // Students can read messages they sent or received
      allow read: if isAssociatedStudent(resource.data.from) || isAssociatedStudent(resource.data.to);

      // Students can create messages originating from themselves
      allow create: if isAssociatedStudent(request.resource.data.from) && request.resource.data.fromType == 'student';
      
      // Allow marking a message as read if you are the recipient
      allow update: if (isAssociatedStudent(resource.data.to) && request.resource.data.read == true && resource.data.read == false);
    }
  }
}
